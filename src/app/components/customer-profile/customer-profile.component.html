<div class="customer-profile-container" style="width:100%; max-width:950px; margin:auto;">

  <!-- Customer Selection List -->
  <div style="margin:32px 0 18px 0; display:flex;align-items:center;gap:20px;">
    <div style="font-size:1.16em;font-weight:700;color:#333;margin-right:22px;">Select Customer:</div>
    <div style="display:flex;gap:14px;">
      <button *ngFor="let c of customers; index as i" (click)="selectCustomer(i)"
        [style.background]="selectedCustomerIdx === i ? '#1976d2' : '#e3e5ef'"
        [style.color]="selectedCustomerIdx === i ? '#fff' : '#333'"
        style="padding:8px 24px;border-radius:8px;border:none;font-size:1em;font-weight:600;cursor:pointer;box-shadow:0 1px 4px rgba(32,44,80,0.09);">
        {{ c.name }}
      </button>
    </div>
  </div>

  <!-- Header: Avatar & Basic Info -->
  <div class="profile-header" style="display:flex; gap:36px; align-items:center; border-bottom:2px solid #eaeaea; padding:28px 0 18px 0; margin-bottom:30px;">
    <div class="profile-avatar" style="width:86px;height:86px;border-radius:50%;background:#dde7f7;display:flex;align-items:center;justify-content:center;font-size:2.9em;color:#1976d2;font-weight:700;box-shadow:0 2px 18px rgba(33,150,243,0.09);">
      {{ customer?.name ? customer.name[0] : '?' }}
    </div>
    <div class="profile-info-block">
      <div class="profile-name" style="font-size:1.7em;font-weight:700;color:#222;margin-bottom:8px;">{{ customer?.name || 'Anonymous User' }}</div>
      <div class="profile-meta-line" style="color:#888;font-size:1.07em;margin-bottom:5px;">
        <span>Mobile: <b>{{ customer?.mobile || 'Unavailable' }}</b></span>
        <span style="margin-left:24px;">ID: <b>{{ customer?.id || 'N/A' }}</b></span>
      </div>
      <div class="profile-meta-line">
        <span style="color:#2196f3; font-weight:600;">Risk Level: {{ customer?.riskLevel || 'N/A' }}</span>
        <span style="margin-left:22px;color:#9370DB;">Branch: {{ customer?.branch || 'Unknown' }}</span>
        <span style="margin-left:22px;color:#009688;">Status: {{ customer?.status || 'Active' }}</span>
      </div>
      <div class="profile-email" style="color:#888;font-size:0.99em;margin-top:7px;">{{ customer?.email || 'Email unavailable' }}</div>
    </div>
    <div class="loyalty-score-box" style="margin-left:auto; display:flex; flex-direction:column; align-items:center;">
      <div style="font-size:1.1em;font-weight:700;color:#333;">Loyalty Score</div>
      <div style="font-size:2.1em;font-weight:800;color:#388e3c;position:relative;cursor:pointer;border-bottom:1.5px dotted #4caf50;" title="Loyalty Score is calculated based on repayment history, loan closure adherence, and referrals.">
        {{ customer?.loyaltyScore || 'N/A' }}
        <span style="font-size:0.95em;color:#898;font-weight:400;position:absolute;top:0;right:-80px">+{{ customer?.referralImpact || 0 }}<span style="color:#388e3c"> pts</span></span>
      </div>
      <div style="color:#919;font-size:0.92em;margin-top:8px;">Referral Impact: <b>+{{ customer?.referralImpact || 0 }} points</b></div>
    </div>
  </div>

  <!-- Section: Referral Details and Loyalty Impact -->
  <div class="referral-section" style="border:1.2px solid #e3e5ef; border-radius:10px; background:#f4fafd;margin-bottom:24px; padding:18px;display:flex;align-items:center;gap:40px;">
    <div class="ref-sec-left" style="flex:1 1 240px;padding-left:4px;">
      <div style="font-weight:700;font-size:1.15em;margin-bottom:8px;">Referral Details</div>
      <div style="color:#2196f3;font-size:1.1em;margin-bottom:2px;">Total Referrals: <b>{{ customer?.referralCount || 'No referral data available' }}</b></div>
      <div *ngIf="customer?.referralCount; else referralMissing" style="font-size:1.02em;color:#666;margin-bottom:2px;">Loyalty score benefit: <span style="font-weight:700;color:#388e3c;">+{{ customer?.referralImpact || 0 }} points</span></div>
      <ng-template #referralMissing>
        <div style="color:#888">No referral data available</div>
      </ng-template>
    </div>
    <div class="ref-sec-graph" style="flex:1 1 350px;">
      <div style="margin-bottom:8px;font-weight:700;color:#222;font-size:1.04em;">Referral Trend</div>
      <!-- Placeholder for real chart, simple horizontal bars for demo -->
      <div *ngIf="customer?.referralHistory && customer.referralHistory.length > 0; else noRefHist">
        <div *ngFor="let ref of customer.referralHistory" style="margin-bottom:6px;display:flex;align-items:center;">
          <span style="width:85px; font-size:0.97em;color:#888;">{{ ref.month }}</span>
          <span style="background:#4caf50;border-radius:6px;height:20px;width:{{ ref.count*18+14 }}px;display:inline-block;"></span>
          <span style="margin-left:8px; color:#222;font-weight:600;">{{ ref.count }} referrals</span>
        </div>
      </div>
      <ng-template #noRefHist>
        <div style="color:#888">No referral history.</div>
      </ng-template>
    </div>
  </div>

  <!-- Repayment History Bar Chart -->
  <div class="repay-history-bar-chart" style="margin-bottom:32px;">
    <div style="font-weight:700;font-size:1.16em;margin-bottom:14px;color:#222;">Repayment History (Visual)</div>
    <div *ngIf="customer?.repaymentHistory && customer.repaymentHistory.length > 0; else noRepHistBar">
      <div style="display:flex;flex-direction:row;gap:13px;margin-bottom:8px;">
        <div *ngFor="let rep of customer.repaymentHistory" style="display:flex;flex-direction:column;align-items:center;">
          <div style="font-size:0.95em;color:#888;">{{ rep.month }}</div>
          <div style="width:40px;height:160px;display:flex;align-items:flex-end;">
            <div [style.background]="rep.status==='OnTime' ? '#388e3c' : rep.status==='Delayed' ? '#FFB300' : '#c62828'"
                 style="width:100%;border-radius:6px;height:{{ rep.status==='OnTime' ? '120px' : rep.status==='Delayed' ? '65px' : '40px' }};transition:height 0.3s;box-shadow:0 1px 5px rgba(95,233,99,0.095);">
            </div>
          </div>
          <div style="margin-top:4px;color:#333;font-weight:600;font-size:1.12em;">{{ rep.amount | currency }}</div>
          <div style="margin-top:2px;font-size:0.93em;font-weight:500;" [style.color]="rep.status==='OnTime' ? '#388e3c' : rep.status==='Delayed' ? '#FFB300' : '#c62828'">
            <span *ngIf="rep.status==='OnTime'">Good</span>
            <span *ngIf="rep.status==='Delayed'">Ok</span>
            <span *ngIf="rep.status==='Missed'">Risk</span>
          </div>
        </div>
      </div>
    </div>
    <ng-template #noRepHistBar>
      <div style="color:#888">No repayment history available.</div>
    </ng-template>
  </div>

  <!-- Graph Section: Repayment & Loyalty -->
  <div class="graph-row" style="display:flex; flex-wrap:wrap; gap:28px; margin-bottom:18px;">
    <div class="graph-block" style="background:#f8fff8;border:1px solid #b6e7c1;border-radius:10px; flex:2 1 370px;min-width:320px;padding:22px 16px;">
      <div style="font-weight:700;font-size:1.13em;margin-bottom:10px;color:#222;">Repayment History (Tabular)</div>
      <div *ngIf="customer?.repaymentHistory && customer.repaymentHistory.length > 0; else noRepayment">
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr style="background:#ebf5ee;color:#333;"><th style="padding:7px 0;text-align:left;font-weight:700;">Month</th><th style="padding:7px 0;text-align:left;font-weight:700;">Repayment</th><th style="padding:7px 0;text-align:left;font-weight:700;">Status</th></tr></thead>
          <tbody>
            <tr *ngFor="let rep of customer.repaymentHistory">
              <td style="padding:7px 0;">{{ rep.month }}</td>
              <td style="padding:7px 0;">{{ rep.amount | currency }}</td>
              <td style="padding:7px 0;">
                <span [style.color]="rep.status === 'OnTime' ? '#388e3c' : rep.status === 'Delayed' ? '#FF9800' : '#c62828'" style="font-weight:700;">
                  <span *ngIf="rep.status==='OnTime'">&#128994; Timely</span>
                  <span *ngIf="rep.status==='Delayed'">&#128997; Delay</span>
                  <span *ngIf="rep.status==='Missed'">&#128308; Missed</span>
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noRepayment>
        <div style="color:#888">No repayment history available.</div>
      </ng-template>
    </div>
    <div class="graph-block" style="background:#f4f5fd;border:1px solid #c9c5ee;border-radius:10px; flex:1 1 260px;min-width:220px;padding:22px 16px;">
      <div style="font-weight:700;font-size:1.13em;margin-bottom:10px;color:#222;">Loan Closures</div>
      <div *ngIf="customer?.loanClosures && customer.loanClosures.length > 0; else noLoanClose">
        <ul style="padding-left:0;list-style:none;">
          <li *ngFor="let lc of customer.loanClosures" style="margin-bottom:9px;color:#222;font-size:1.06em;">
            <span style="font-weight:600;color:{{ lc.status==='Closed' ? '#388e3c' : '#FF9800' }};">&#128218;</span>
            {{ lc.month }} - <span style="font-weight:700">{{ lc.status }}</span>
          </li>
        </ul>
      </div>
      <ng-template #noLoanClose>
        <div style="color:#888">No loan closure data.</div>
      </ng-template>
    </div>
  </div>

  <!-- Section: AI Insights -->
  <div class="ai-insights-card" style="border:1px solid #dedede; border-radius:6px; margin-bottom:24px;background:#fafdff;">
    <div style="padding: 16px 18px 10px 18px; border-bottom: 1px solid #eee; font-weight:700; font-size:1.1em;">AI Insights</div>
    <div style="padding: 18px;">
      <div *ngIf="aiInsights && aiInsights.length > 0; else noInsights">
        <ul style="padding-left:0;margin:0;list-style:none;">
          <li *ngFor="let insight of aiInsights" style="margin-bottom:10px; display:flex; align-items:center;">
            <span style="font-size:1.1em; margin-right:8px; color: #2196f3;">&#9889;</span>
            <span class="insight-text">{{ insight }}</span>
          </li>
        </ul>
      </div>
      <ng-template #noInsights>
        <p class="no-insights" style="color:#888;">No insights available for this customer.</p>
      </ng-template>
      <button (click)="refreshInsights()" style="margin-top:16px;padding:8px 18px; border-radius:8px;background:#1976d2;color:#fff;border:none;font-size:1em;font-weight:600;cursor:pointer;">Regenerate Insights</button>
    </div>
  </div>
</div>
